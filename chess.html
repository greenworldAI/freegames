<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess - Zentroll Freegames</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h2 {
      color: #333;
      margin-bottom: 20px;
    }
    #board {
      width: 400px;
      margin: 0 auto 20px auto;
    }
    #status {
      display: block;
      margin: 10px 0;
      font-weight: bold;
    }
    #move-history {
      width: 400px;
      margin: 20px auto;
      text-align: left;
      max-height: 150px;
      overflow-y: auto;
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #move-history h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    #move-history ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #move-history li {
      margin: 5px 0;
      font-size: 14px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:hover {
      background-color: #0056b3;
    }
    /* Ensure pieces are visible */
    .piece {
      position: absolute !important;
      width: 100% !important;
      height: 100% !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      z-index: 1 !important;
      display: block !important;
      opacity: 1 !important;
    }
    .square-55d63 {
      position: relative;
      z-index: 0;
    }
  </style>
</head>
<body>
  <h2>Chess on Zentroll Freegames</h2>
  <div id="board"></div>
  <p>Status: <span id="status"></span></p>
  <button onclick="resetGame()">Reset Game</button>
  <div id="move-history">
    <h3>Move History</h3>
    <ul id="move-list"></ul>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <script>
    var board = null;
    var game = new Chess();
    console.log('game methods:', Object.keys(game)); // Debug: Log available methods
    var $status = document.getElementById('status');
    var $moveList = document.getElementById('move-list');

    var pieceValues = { p: 1, n: 3, b: 3, r: 5, q: 9, k: 200 };
    var pawnSquareTable = [
      0,  0,  0,  0,  0,  0,  0,  0,
      50, 50, 50, 50, 50, 50, 50, 50,
      10, 10, 20, 30, 30, 20, 10, 10,
      5,  5, 10, 25, 25, 10,  5,  5,
      0,  0,  0, 20, 20,  0,  0,  0,
      5, -5,-10,  0,  0,-10, -5,  5,
      5, 10, 10,-20,-20, 10, 10,  5,
      0,  0,  0,  0,  0,  0,  0,  0
    ];
    var knightSquareTable = [
      -50,-40,-30,-30,-30,-30,-40,-50,
      -40,-20,  0,  0,  0,  0,-20,-40,
      -30,  0, 10, 15, 15, 10,  0,-30,
      -30,  5, 15, 20, 20, 15,  5,-30,
      -30,  0, 15, 20, 20, 15,  0,-30,
      -30,  5, 10, 15, 15, 10,  5,-30,
      -40,-20,  0,  5,  5,  0,-20,-40,
      -50,-40,-30,-30,-30,-30,-40,-50
    ];
    var bishopSquareTable = knightSquareTable;
    var rookSquareTable = pawnSquareTable;
    var queenSquareTable = pawnSquareTable;
    var kingSquareTable = [
      -30,-40,-40,-50,-50,-40,-40,-30,
      -30,-40,-40,-50,-50,-40,-40,-30,
      -30,-40,-40,-50,-50,-40,-40,-30,
      -30,-40,-40,-50,-50,-40,-40,-30,
      -20,-30,-30,-40,-40,-30,-30,-20,
      -10,-20,-20,-20,-20,-20,-20,-10,
      20, 20,  0,  0,  0,  0, 20, 20,
      20, 30, 10,  0,  0, 10, 30, 20
    ];

    // Function to parse FEN and build board state
    function getBoardFromFEN(fen) {
      var board = [];
      var rows = fen.split(' ')[0].split('/');
      for (var i = 0; i < 8; i++) {
        var row = [];
        var cols = rows[i].split('');
        var colIndex = 0;
        for (var j = 0; j < cols.length; j++) {
          if (isNaN(cols[j])) {
            row[colIndex] = { type: cols[j].toLowerCase(), color: cols[j] === cols[j].toUpperCase() ? 'w' : 'b' };
            colIndex++;
          } else {
            for (var k = 0; k < parseInt(cols[j]); k++) {
              row[colIndex] = null;
              colIndex++;
            }
          }
        }
        board[i] = row;
      }
      return board;
    }

    function evaluateBoard() {
      var totalEvaluation = 0;
      var board = getBoardFromFEN(game.fen());
      console.log('Board state from FEN:', board); // Debug: Log the board state
      for (var i = 0; i < 8; i++) {
        for (var j = 0; j < 8; j++) {
          var piece = board[i][j];
          if (piece) {
            var value = pieceValues[piece.type] * (piece.color === 'w' ? 1 : -1);
            var squareIndex = i * 8 + j;
            var table = piece.type === 'p' ? pawnSquareTable :
                        piece.type === 'n' ? knightSquareTable :
                        piece.type === 'b' ? bishopSquareTable :
                        piece.type === 'r' ? rookSquareTable :
                        piece.type === 'q' ? queenSquareTable : kingSquareTable;
            value += (piece.color === 'w' ? table[squareIndex] : table[63 - squareIndex]) / 100;
            totalEvaluation += value;
          }
        }
      }
      return totalEvaluation;
    }

    function minimax(depth, game, alpha, beta, isMaximizingPlayer) {
      if (depth === 0 || game.game_over()) {
        return [evaluateBoard(), null];
      }

      var possibleMoves = game.moves();
      var bestMove = null;

      if (isMaximizingPlayer) {
        var bestValue = -Infinity;
        for (var i = 0; i < possibleMoves.length; i++) {
          game.move(possibleMoves[i]);
          var [value] = minimax(depth - 1, game, alpha, beta, false);
          game.undo();
          if (value > bestValue) {
            bestValue = value;
            bestMove = possibleMoves[i];
          }
          alpha = Math.max(alpha, bestValue);
          if (beta <= alpha) break;
        }
        return [bestValue, bestMove];
      } else {
        var bestValue = Infinity;
        for (var i = 0; i < possibleMoves.length; i++) {
          game.move(possibleMoves[i]);
          var [value] = minimax(depth - 1, game, alpha, beta, true);
          game.undo();
          if (value < bestValue) {
            bestValue = value;
            bestMove = possibleMoves[i];
          }
          beta = Math.min(beta, bestValue);
          if (beta <= alpha) break;
        }
        return [bestValue, bestMove];
      }
    }

    function makeAIMove() {
      var [value, bestMove] = minimax(3, game, -Infinity, Infinity, false);
      if (bestMove) {
        game.move(bestMove);
        board.position(game.fen());
        updateStatus();
        updateMoveHistory();
      }
    }

    function onDragStart(source, piece, position, orientation) {
      if (game.game_over()) return false;
      if (piece.search(/^b/) !== -1) return false;
    }

    function onDrop(source, target) {
      var move = game.move({
        from: source,
        to: target,
        promotion: 'q'
      });

      if (move === null) return 'snapback';
      window.setTimeout(makeAIMove, 250);
      updateStatus();
      updateMoveHistory();
    }

    function onSnapEnd() {
      board.position(game.fen());
    }

    function updateStatus() {
      var status = '';
      var moveColor = game.turn() === 'w' ? 'White' : 'Black';
      if (game.in_checkmate()) {
        status = 'Game over, ' + moveColor + ' is in checkmate.';
      } else if (game.in_draw()) {
        status = 'Game over, drawn position';
      } else {
        status = moveColor + ' to move';
        if (game.in_check()) {
          status += ', ' + moveColor + ' is in check';
        }
      }
      $status.innerHTML = status;
    }

    function updateMoveHistory() {
      var history = game.history();
      $moveList.innerHTML = '';
      for (var i = 0; i < history.length; i++) {
        var moveNumber = Math.floor(i / 2) + 1;
        var moveText = history[i];
        if (i % 2 === 0) {
          $moveList.innerHTML += '<li>' + moveNumber + '. ' + moveText + ' ';
        } else {
          $moveList.innerHTML += moveText + '</li>';
        }
      }
      if (history.length % 2 === 1) {
        $moveList.lastChild.innerHTML += '</li>';
      }
    }

    function resetGame() {
      game.reset();
      board.start();
      updateStatus();
      updateMoveHistory();
    }

    var cfg = {
      draggable: true,
      position: 'start',
      pieceTheme: function(piece) {
        var url = 'img/chesspieces/merida/' + piece + '.png';
        console.log('Loading piece:', piece, 'from URL:', url); // Debug: Log piece image URLs
        return url;
      },
      onDragStart: onDragStart,
      onDrop: onDrop,
      onSnapEnd: onSnapEnd
    };
    console.log('Chessboard config:', cfg); // Debug: Log the configuration
    board = Chessboard('board', cfg);

    // Debug: Check piece elements after board initialization
    setTimeout(function() {
      var pieceElements = document.querySelectorAll('.piece');
      console.log('Piece elements found:', pieceElements.length);
      pieceElements.forEach(function(el) {
        console.log('Piece element:', el.className, 'Style:', el.style.cssText);
      });
    }, 1000);

    updateStatus();
    updateMoveHistory();
  </script>
</body>
</html>
